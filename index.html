<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Forensics Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; }
      .login-container, .password-change-container { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 400px; }
      .password-change-container { display: none; }
      .login-header { text-align: center; margin-bottom: 30px; }
      .login-header h1 { color: #333; font-size: 24px; margin-bottom: 8px; }
      .login-header p { color: #666; }
      .form-group { margin-bottom: 20px; }
      .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
      .form-group input { width: 100%; padding: 12px 16px; border: 2px solid #e1e1e1; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
      .form-group input:focus { outline: none; border-color: #667eea; }
      button { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
      button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
      button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
      .error { color: #e74c3c; text-align: center; margin-top: 15px; display: none; }
      .info { color: #3498db; text-align: center; margin-bottom: 20px; font-size: 14px; }
      .back-link { text-align: center; margin-top: 15px; }
      .back-link a { color: #667eea; text-decoration: none; font-size: 14px; }
      .chat-container { display: none; background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 900px; height: 85vh; flex-direction: column; }
      .chat-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; }
      .chat-header h1 { font-size: 20px; }
      .user-info { font-size: 12px; opacity: 0.9; margin-top: 4px; }
      .logout-btn { background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 6px; width: auto; }
      .messages { flex: 1; overflow-y: auto; padding: 20px; }
      .message { margin-bottom: 16px; padding: 16px; border-radius: 12px; max-width: 85%; }
      .message.user { background: #667eea; color: white; margin-left: auto; }
      .message.assistant { background: #f5f5f5; color: #333; line-height: 1.6; }
      .message.assistant h1, .message.assistant h2, .message.assistant h3 { margin: 16px 0 8px 0; color: #333; }
      .message.assistant h1 { font-size: 1.5em; }
      .message.assistant h2 { font-size: 1.3em; }
      .message.assistant h3 { font-size: 1.1em; }
      .message.assistant p { margin: 12px 0; }
      .message.assistant ul, .message.assistant ol { margin: 12px 0; padding-left: 24px; }
      .message.assistant li { margin: 6px 0; }
      .message.assistant strong { font-weight: 600; }
      .message.assistant code { background: #e8e8e8; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
      .message.assistant pre { background: #2d2d2d; color: #f8f8f2; padding: 16px; border-radius: 8px; overflow-x: auto; margin: 12px 0; }
      .message.assistant pre code { background: none; padding: 0; color: inherit; }
      .input-area { padding: 20px; border-top: 1px solid #e1e1e1; display: flex; gap: 12px; }
      .input-area input { flex: 1; padding: 12px 16px; border: 2px solid #e1e1e1; border-radius: 8px; font-size: 16px; }
      .input-area input:focus { outline: none; border-color: #667eea; }
      .input-area button { width: auto; padding: 12px 24px; }
      .loading { display: none; text-align: center; padding: 20px; }
      .loading span { display: inline-block; width: 8px; height: 8px; background: #667eea; border-radius: 50%; margin: 0 4px; animation: bounce 1.4s infinite; }
      .loading span:nth-child(2) { animation-delay: 0.2s; }
      .loading span:nth-child(3) { animation-delay: 0.4s; }
      @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
  </head>
  <body>
    <div id="loginSection" class="login-container">
      <div class="login-header"><h1>Claude Forensics Chat</h1><p>Employee Dashboard</p></div>
      <div class="form-group"><label for="email">Email Address</label><input type="email" id="email" placeholder="your.email@example.com"></div>
      <div class="form-group"><label for="password">Password</label><input type="password" id="password" placeholder="Enter your password"></div>
      <button onclick="login()" id="loginBtn">Sign In</button>
      <div id="loginError" class="error"></div>
    </div>
    <div id="passwordChangeSection" class="password-change-container">
      <div class="login-header"><h1>Set New Password</h1><p>Your temporary password has expired</p></div>
      <p class="info">Please create a new password to continue.</p>
      <div class="form-group"><label for="newPassword">New Password</label><input type="password" id="newPassword" placeholder="Enter new password"></div>
      <div class="form-group"><label for="confirmPassword">Confirm Password</label><input type="password" id="confirmPassword" placeholder="Confirm new password"></div>
      <button onclick="completeNewPassword()" id="changePasswordBtn">Set Password</button>
      <div id="passwordError" class="error"></div>
      <div class="back-link"><a href="#" onclick="backToLogin()">Back to Login</a></div>
    </div>
    <div id="chatSection" class="chat-container">
      <div class="chat-header">
        <div><h1>Claude Forensics Chat</h1><p class="user-info" id="userEmail"></p></div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
      <div class="messages" id="chatContainer">
        <div class="message assistant">Welcome! I'm Claude, ready to help. What would you like to know?</div>
      </div>
      <div class="loading" id="loading"><span></span><span></span><span></span></div>
      <div class="input-area">
        <input type="text" id="messageInput" placeholder="Type your question..." onkeypress="if(event.key==='Enter')sendMessage()">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6/dist/amazon-cognito-identity.min.js"></script>
    <script>
      const STREAM_ENDPOINT = 'https://4voqfpwhf7tiyzxpqcejedrtii0fyhrv.lambda-url.us-east-2.on.aws/';
      const COGNITO_USER_POOL_ID = 'us-east-2_gCTbH7Sek';
      const COGNITO_CLIENT_ID = 'k8bk5a0462fmoobi07k4gplat';
      const poolData = { UserPoolId: COGNITO_USER_POOL_ID, ClientId: COGNITO_CLIENT_ID };
      const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
      let currentUser = null;
      let idToken = null;
      let conversationHistory = [];
      let cognitoUserForPasswordChange = null;
      let userAttributesForPasswordChange = null;

      window.onload = function() {
        const cognitoUser = userPool.getCurrentUser();
        if (cognitoUser) {
          cognitoUser.getSession((err, session) => {
            if (err || !session.isValid()) return;
            currentUser = cognitoUser;
            idToken = session.getIdToken().getJwtToken();
            showChat(cognitoUser.getUsername());
          });
        }
      };

      function login() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('loginError');
        const loginBtn = document.getElementById('loginBtn');
        if (!email || !password) { errorDiv.textContent = 'Please enter both email and password'; errorDiv.style.display = 'block'; return; }
        errorDiv.style.display = 'none';
        loginBtn.disabled = true;
        loginBtn.textContent = 'Signing in...';
        const authDetails = new AmazonCognitoIdentity.AuthenticationDetails({ Username: email, Password: password });
        const cognitoUser = new AmazonCognitoIdentity.CognitoUser({ Username: email, Pool: userPool });
        cognitoUser.authenticateUser(authDetails, {
          onSuccess: function(result) { currentUser = cognitoUser; idToken = result.getIdToken().getJwtToken(); loginBtn.disabled = false; loginBtn.textContent = 'Sign In'; showChat(email); },
          onFailure: function(err) { loginBtn.disabled = false; loginBtn.textContent = 'Sign In'; errorDiv.textContent = err.message || 'Authentication failed'; errorDiv.style.display = 'block'; },
          newPasswordRequired: function(userAttributes) { cognitoUserForPasswordChange = cognitoUser; delete userAttributes.email_verified; delete userAttributes.email; userAttributesForPasswordChange = userAttributes; loginBtn.disabled = false; loginBtn.textContent = 'Sign In'; showPasswordChangeSection(); }
        });
      }

      function showPasswordChangeSection() { document.getElementById('loginSection').style.display = 'none'; document.getElementById('passwordChangeSection').style.display = 'block'; }
      function backToLogin() { document.getElementById('passwordChangeSection').style.display = 'none'; document.getElementById('loginSection').style.display = 'block'; }

      function completeNewPassword() {
        const newPw = document.getElementById('newPassword').value;
        const confirmPw = document.getElementById('confirmPassword').value;
        const errorDiv = document.getElementById('passwordError');
        const btn = document.getElementById('changePasswordBtn');
        if (!newPw || !confirmPw) { errorDiv.textContent = 'Please fill in both fields'; errorDiv.style.display = 'block'; return; }
        if (newPw !== confirmPw) { errorDiv.textContent = 'Passwords do not match'; errorDiv.style.display = 'block'; return; }
        btn.disabled = true; btn.textContent = 'Setting password...';
        cognitoUserForPasswordChange.completeNewPasswordChallenge(newPw, userAttributesForPasswordChange, {
          onSuccess: function(result) { currentUser = cognitoUserForPasswordChange; idToken = result.getIdToken().getJwtToken(); btn.disabled = false; btn.textContent = 'Set Password'; document.getElementById('passwordChangeSection').style.display = 'none'; showChat(cognitoUserForPasswordChange.getUsername()); },
          onFailure: function(err) { btn.disabled = false; btn.textContent = 'Set Password'; errorDiv.textContent = err.message; errorDiv.style.display = 'block'; }
        });
      }

      function showChat(email) { document.getElementById('loginSection').style.display = 'none'; document.getElementById('chatSection').style.display = 'flex'; document.getElementById('userEmail').textContent = 'Logged in as: ' + email; conversationHistory = []; }

      function logout() { if (currentUser) currentUser.signOut(); currentUser = null; idToken = null; conversationHistory = []; document.getElementById('chatSection').style.display = 'none'; document.getElementById('loginSection').style.display = 'block'; document.getElementById('chatContainer').innerHTML = '<div class="message assistant">Welcome! I\'m Claude, ready to help. What would you like to know?</div>'; }

      async function sendMessage() {
        if (!currentUser || !idToken) { alert('Session expired. Please log in again.'); logout(); return; }
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        if (!message) return;
        const chatContainer = document.getElementById('chatContainer');
        const loading = document.getElementById('loading');
        const userDiv = document.createElement('div');
        userDiv.className = 'message user';
        userDiv.textContent = message;
        chatContainer.appendChild(userDiv);
        input.value = '';
        chatContainer.scrollTop = chatContainer.scrollHeight;
        loading.style.display = 'block';

        const assistantDiv = document.createElement('div');
        assistantDiv.className = 'message assistant';
        assistantDiv.innerHTML = '';
        chatContainer.appendChild(assistantDiv);

        let fullText = '';

        try {
          const response = await fetch(STREAM_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': idToken },
            body: JSON.stringify({ message: message, conversationHistory: conversationHistory })
          });

          loading.style.display = 'none';

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n\n');
            buffer = lines.pop();

            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const data = JSON.parse(line.slice(6));
                  if (data.type === 'delta') {
                    fullText += data.text;
                    assistantDiv.innerHTML = marked.parse(fullText);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                  } else if (data.type === 'done') {
                    conversationHistory = data.updatedHistory;
                  } else if (data.type === 'error') {
                    assistantDiv.textContent = 'Error: ' + data.error;
                  }
                } catch (e) { /* skip malformed */ }
              }
            }
          }

          if (!fullText) {
            assistantDiv.textContent = 'No response received. Please try again.';
          }
        } catch (error) {
          loading.style.display = 'none';
          assistantDiv.textContent = 'Sorry, there was an error connecting to the server.';
        }
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    </script>
  </body>
</html>
